<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通話サイト</title>
    <style>
        /* 全体のレイアウト設定 */
        body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f0f0;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 300px;
            text-align: center;
        }

        h1 {
            margin-bottom: 20px;
            font-size: 24px;
            color: #333;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #message {
            margin-top: 20px;
            font-size: 14px;
            color: #ff6347;
        }

        /* 音声の非表示 */
        audio {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="content">
            <h1>部屋に入室</h1>
            <input type="text" id="password" placeholder="部屋のパスワードを入力">
            <button onclick="joinRoom()">部屋に入る</button>
            <div id="message"></div>
        </div>
    </div>

    <audio id="localAudio" autoplay muted></audio> <!-- 自分の音声 -->
    <audio id="remoteAudio" autoplay></audio> <!-- 相手の音声 -->

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // Supabaseクライアント設定
        const supabase = createClient('https://amacjdbgauaaeicrzgxc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtYWNqZGJnYXVhYWVpY3J6Z3hjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNzU5MzcsImV4cCI6MjA3Mzg1MTkzN30.wS-MpPFY5jwegyG2FVwhvF_GHU-vMWeEBbOOo9cNtmw');

        // 部屋に入室
        async function joinRoom() {
            const password = document.getElementById('password').value;

            if (!password) {
                document.getElementById('message').textContent = 'パスワードを入力してください。';
                return;
            }

            // パスワードで部屋を検索
            const { data: room, error } = await supabase
                .from('rooms')
                .select('*')
                .eq('password', password)
                .single();

            if (error || !room) {
                // 部屋が見つからない場合、新しい部屋を作成
                await createNewRoom(password);
            } else {
                document.getElementById('message').textContent = `部屋「${room.room_name}」に入室しました！`;
                startCall(room.id);
            }
        }

        // 新しい部屋を作成
        async function createNewRoom(password) {
            const roomName = `Room-${Math.random().toString(36).substr(2, 9)}`;  // ランダムな部屋名

            const { data, error } = await supabase
                .from('rooms')
                .insert([{ room_name: roomName, password: password }]);

            if (error) {
                document.getElementById('message').textContent = '部屋の作成に失敗しました。';
            } else {
                document.getElementById('message').textContent = `部屋「${roomName}」が作成されました！`;
                startCall(data[0].id);
            }
        }

        // 通話開始
        async function startCall(roomId) {
            let localStream;
            let peerConnection;
            const serverConfig = {
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            };

            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const localAudio = document.getElementById('localAudio');
            localAudio.srcObject = localStream;

            peerConnection = new RTCPeerConnection(serverConfig);
            peerConnection.addEventListener('icecandidate', handleIceCandidate);
            peerConnection.addEventListener('track', handleTrackEvent);

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            const { data, error } = await supabase
                .from('calls')
                .insert([{ room_id: roomId, offer: JSON.stringify(offer) }]);

            if (error) {
                console.error('オファー送信失敗:', error);
            }
        }

        // ICE候補を送信
        function handleIceCandidate(event) {
            if (event.candidate) {
                sendIceCandidate(event.candidate);
            }
        }

        // ICE候補をSupabaseに送信
        async function sendIceCandidate(candidate) {
            const { data, error } = await supabase
                .from('calls')
                .update({ ice_candidates: supabase.raw('array_append(ice_candidates, ?)', [JSON.stringify(candidate)]) })
                .eq('room_id', currentRoomId);

            if (error) {
                console.error('ICE候補送信失敗:', error);
            }
        }

        // 音声の受信
        function handleTrackEvent(event) {
            const remoteAudio = document.getElementById('remoteAudio');
            remoteAudio.srcObject = event.streams[0];
        }

        // リアルタイムデータの受信
        const messagesChannel = supabase
            .channel('calls')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'calls' }, payload => {
                const newCall = payload.new;
                console.log('新しい通話情報:', newCall);

                if (newCall.offer) {
                    handleOffer(newCall);  // 受け取ったオファーを処理
                }
                if (newCall.answer) {
                    handleAnswer(newCall); // 受け取ったアンサーを処理
                }
                if (newCall.ice_candidates) {
                    handleIceCandidates(newCall); // 受け取ったICE候補を処理
                }
            })
            .subscribe();

        // オファー処理
        function handleOffer(callData) {
            const offer = new RTCSessionDescription(JSON.parse(callData.offer));
            peerConnection.setRemoteDescription(offer);

            peerConnection.createAnswer().then(answer => {
                peerConnection.setLocalDescription(answer);
                sendAnswer(callData.id, answer);
            });
        }

        // アンサーを送信
        async function sendAnswer(callId, answer) {
            const { data, error } = await supabase
                .from('calls')
                .update({ answer: JSON.stringify(answer) })
                .eq('id', callId);

            if (error) {
                console.error('アンサー送信失敗:', error);
            }
        }

        // ICE候補を処理
        function handleIceCandidates(callData) {
            callData.ice_candidates.forEach(candidate => {
                const iceCandidate = new RTCIceCandidate(JSON.parse(candidate));
                peerConnection.addIceCandidate(iceCandidate);
            });
        }
    </script>
</body>
</html>
